<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Digital Umbrella - BNPL Risk Scoring Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0',
                            300: '#86efac', 400: '#4ade80', 500: '#22c55e',
                            600: '#16a34a', 700: '#15803d', 800: '#166534', 900: '#14532d'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gauge-ring { transition: stroke-dashoffset 1s ease-in-out; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card-hover { transition: all 0.2s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .bar-animate { transition: width 0.8s ease-in-out; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root">
        <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;">
            <p style="color:#888;font-size:18px;">Loading dashboard...</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Check if page is opened directly (file://) instead of via server
        if (window.location.protocol === 'file:') {
            document.getElementById('root').innerHTML = `
                <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;">
                    <div style="max-width:600px;background:white;border-radius:12px;padding:40px;box-shadow:0 4px 6px rgba(0,0,0,0.1);">
                        <div style="text-align:center;margin-bottom:30px;">
                            <div style="font-size:64px;margin-bottom:10px;">‚ö†Ô∏è</div>
                            <h1 style="font-size:24px;font-weight:bold;color:#dc2626;margin-bottom:10px;">Dashboard Cannot Load</h1>
                            <p style="color:#666;font-size:14px;">You opened the HTML file directly. Please use the backend server instead.</p>
                        </div>

                        <div style="background:#fef2f2;border:2px solid #fecaca;border-radius:8px;padding:20px;margin-bottom:20px;">
                            <h3 style="font-weight:600;margin-bottom:10px;color:#991b1b;">‚úã Why doesn't it work?</h3>
                            <p style="color:#666;font-size:14px;line-height:1.6;">
                                The dashboard needs to communicate with the backend API. When you open the HTML file directly,
                                the browser blocks API requests for security reasons (CORS policy).
                            </p>
                        </div>

                        <div style="background:#ecfdf5;border:2px solid #a7f3d0;border-radius:8px;padding:20px;">
                            <h3 style="font-weight:600;margin-bottom:15px;color:#065f46;">‚úÖ How to fix:</h3>
                            <ol style="color:#666;font-size:14px;line-height:2;padding-left:20px;">
                                <li><strong>Step 1:</strong> Open terminal/command prompt</li>
                                <li><strong>Step 2:</strong> Navigate to backend folder:
                                    <div style="background:#1f2937;color:#10b981;padding:10px;border-radius:6px;margin-top:8px;font-family:monospace;font-size:13px;">
                                        cd backend
                                    </div>
                                </li>
                                <li><strong>Step 3:</strong> Run the backend server:
                                    <div style="background:#1f2937;color:#10b981;padding:10px;border-radius:6px;margin-top:8px;font-family:monospace;font-size:13px;">
                                        python main.py
                                    </div>
                                </li>
                                <li><strong>Step 4:</strong> The dashboard will open automatically in your browser at:
                                    <div style="background:#1f2937;color:#10b981;padding:10px;border-radius:6px;margin-top:8px;font-family:monospace;font-size:13px;">
                                        http://localhost:8000
                                    </div>
                                </li>
                            </ol>
                        </div>

                        <div style="text-align:center;margin-top:30px;padding-top:20px;border-top:1px solid #e5e7eb;">
                            <p style="color:#666;font-size:13px;">
                                üìö Need help? Check the README.md file for detailed instructions
                            </p>
                        </div>
                    </div>
                </div>
            `;
            throw new Error('Page opened directly - backend server required');
        }

        const API_BASE = '/api/v1';

        // ===== RISK SCORE GAUGE =====
        function RiskScoreGauge({ score, category }) {
            const radius = 80;
            const circumference = 2 * Math.PI * radius;
            const progress = (score / 100) * circumference;
            const offset = circumference - progress;

            const getColor = () => {
                if (score >= 80) return { stroke: '#22c55e', bg: '#f0fdf4', text: 'text-green-600' };
                if (score >= 60) return { stroke: '#f59e0b', bg: '#fffbeb', text: 'text-amber-600' };
                if (score >= 40) return { stroke: '#f97316', bg: '#fff7ed', text: 'text-orange-600' };
                return { stroke: '#ef4444', bg: '#fef2f2', text: 'text-red-600' };
            };
            const color = getColor();

            return (
                <div className="flex flex-col items-center">
                    <svg width="200" height="200" viewBox="0 0 200 200">
                        <circle cx="100" cy="100" r={radius} fill="none" stroke="#e5e7eb" strokeWidth="12" />
                        <circle cx="100" cy="100" r={radius} fill="none"
                            stroke={color.stroke} strokeWidth="12"
                            strokeDasharray={circumference} strokeDashoffset={offset}
                            strokeLinecap="round" transform="rotate(-90 100 100)"
                            className="gauge-ring" />
                        <text x="100" y="90" textAnchor="middle" fill="#1f2937" fontSize="42" fontWeight="700">{score}</text>
                        <text x="100" y="115" textAnchor="middle" fill="#6b7280" fontSize="14">/100</text>
                    </svg>
                    <span className={`mt-2 px-4 py-1.5 rounded-full text-sm font-semibold ${color.text}`}
                          style={{ backgroundColor: color.bg }}>
                        {category} Risk
                    </span>
                </div>
            );
        }

        // ===== STAT CARD =====
        function StatCard({ title, value, subtitle, icon }) {
            return (
                <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100 card-hover">
                    <div className="flex items-center gap-3 mb-2">
                        <span className="text-2xl">{icon}</span>
                        <span className="text-sm text-gray-500 font-medium">{title}</span>
                    </div>
                    <div className="text-2xl font-bold text-gray-900">{value}</div>
                    {subtitle && <div className="text-xs text-gray-400 mt-1">{subtitle}</div>}
                </div>
            );
        }

        // ===== LATE PAYMENT BAR =====
        function LatePaymentBar({ probability }) {
            const getColor = () => {
                if (probability <= 15) return 'bg-green-500';
                if (probability <= 30) return 'bg-amber-500';
                if (probability <= 50) return 'bg-orange-500';
                return 'bg-red-500';
            };
            return (
                <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
                    <div className="flex justify-between items-center mb-2">
                        <span className="text-sm font-medium text-gray-700">Late Payment Probability</span>
                        <span className="text-lg font-bold text-gray-900">{probability}%</span>
                    </div>
                    <div className="w-full bg-gray-100 rounded-full h-4">
                        <div className={`h-4 rounded-full bar-animate ${getColor()}`}
                             style={{ width: probability + '%' }} />
                    </div>
                </div>
            );
        }

        // ===== RISK FACTOR BREAKDOWN =====
        function RiskFactorBreakdown({ explanation }) {
            if (!explanation || !explanation.factors) return null;
            return (
                <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                    <h3 className="text-lg font-semibold text-gray-900 mb-4">Risk Factor Breakdown</h3>
                    <div className="space-y-4">
                        {explanation.factors.map((factor, i) => {
                            const pct = (factor.weighted_contribution / factor.max_contribution) * 100;
                            const isGood = factor.icon === 'check';
                            return (
                                <div key={i}>
                                    <div className="flex justify-between items-center mb-1">
                                        <div className="flex items-center gap-2">
                                            <span className={isGood ? 'text-green-500 font-bold' : 'text-amber-500 font-bold'}>
                                                {isGood ? '\u2713' : '\u26A0'}
                                            </span>
                                            <span className="text-sm font-medium text-gray-700">{factor.factor}</span>
                                        </div>
                                        <span className="text-sm text-gray-500 font-mono">
                                            {factor.weighted_contribution} / {factor.max_contribution}
                                        </span>
                                    </div>
                                    <div className="w-full bg-gray-100 rounded-full h-3">
                                        <div className="h-3 rounded-full bar-animate"
                                             style={{ width: pct + '%', backgroundColor: isGood ? '#22c55e' : '#f59e0b' }} />
                                    </div>
                                    <p className="text-xs text-gray-400 mt-1">{factor.value}</p>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // ===== PRODUCT RECOMMENDATIONS =====
        function ProductRecommendations({ products }) {
            if (!products || !products.recommendations) return null;
            const priorityColors = {
                high: 'bg-red-100 text-red-700',
                medium: 'bg-amber-100 text-amber-700',
                low: 'bg-blue-100 text-blue-700',
            };
            return (
                <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                    <h3 className="text-lg font-semibold text-gray-900 mb-4">Recommended Products</h3>
                    {products.recommendations.length === 0 ? (
                        <p className="text-gray-400 text-sm">No product recommendations available.</p>
                    ) : (
                        <div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead>
                                        <tr className="border-b border-gray-100">
                                            <th className="text-left py-3 px-2 text-gray-500 font-medium">Product</th>
                                            <th className="text-left py-3 px-2 text-gray-500 font-medium">Category</th>
                                            <th className="text-right py-3 px-2 text-gray-500 font-medium">Price</th>
                                            <th className="text-center py-3 px-2 text-gray-500 font-medium">Priority</th>
                                            <th className="text-center py-3 px-2 text-gray-500 font-medium">Match</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {products.recommendations.map((rec, i) => (
                                            <tr key={i} className="border-b border-gray-50 hover:bg-gray-50">
                                                <td className="py-3 px-2">
                                                    <div className="font-medium text-gray-900">{rec.name}</div>
                                                    <div className="text-xs text-gray-400">{rec.estimated_quantity}</div>
                                                </td>
                                                <td className="py-3 px-2 text-gray-600 capitalize">{rec.category.replace(/_/g, ' ')}</td>
                                                <td className="py-3 px-2 text-right font-medium text-gray-900">{rec.estimated_price.toLocaleString()} AZN</td>
                                                <td className="py-3 px-2 text-center">
                                                    <span className={'px-2.5 py-1 rounded-full text-xs font-medium ' + (priorityColors[rec.priority] || '')}>
                                                        {rec.priority}
                                                    </span>
                                                </td>
                                                <td className="py-3 px-2 text-center text-gray-600">{rec.match_score}%</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            <div className="mt-4 flex justify-between items-center pt-4 border-t border-gray-100">
                                <span className="text-sm text-gray-500">Total Estimated Cost</span>
                                <span className="text-lg font-bold text-gray-900">{products.total_estimated_cost.toLocaleString()} AZN</span>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ===== EXPLAINABILITY PANEL =====
        function ExplainabilityPanel({ explanation }) {
            const [isOpen, setIsOpen] = useState(false);
            if (!explanation) return null;
            return (
                <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex justify-between items-center">
                        <h3 className="text-lg font-semibold text-gray-900">Explainability Report</h3>
                        <span className="text-gray-400 text-xl">{isOpen ? '\u25B2' : '\u25BC'}</span>
                    </button>
                    {isOpen && (
                        <div className="mt-4 fade-in">
                            <div className="bg-gray-50 rounded-lg p-4 mb-4">
                                <p className="text-sm text-gray-700 leading-relaxed">{explanation.summary}</p>
                            </div>
                            <div className="space-y-2">
                                {explanation.factors && explanation.factors.map((f, i) => (
                                    <div key={i} className="flex items-start gap-2 text-sm">
                                        <span className={f.icon === 'check' ? 'text-green-500 mt-0.5' : 'text-amber-500 mt-0.5'}>
                                            {f.icon === 'check' ? '\u2713' : '\u26A0'}
                                        </span>
                                        <span className="text-gray-600">{f.description}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ===== FARMER SELECTOR =====
        function FarmerSelector({ farmers, selectedId, onSelect }) {
            return (
                <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Select Farmer</label>
                    <select value={selectedId} onChange={(e) => onSelect(e.target.value)}
                        className="w-full px-4 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none bg-white">
                        {farmers.map(f => (
                            <option key={f.farmer_id} value={f.farmer_id}>
                                {f.name} ({f.farmer_id}) - {f.region}, {f.crop_type}
                            </option>
                        ))}
                    </select>
                </div>
            );
        }

        // ===== SIMPLE BAR CHART (no external dependency) =====
        function SimpleBarChart({ summaries }) {
            if (!summaries) return null;
            const maxScore = 100;
            const getBarColor = (score) => {
                if (score >= 80) return '#22c55e';
                if (score >= 60) return '#f59e0b';
                if (score >= 40) return '#f97316';
                return '#ef4444';
            };
            return (
                <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                    <h3 className="text-lg font-semibold text-gray-900 mb-4">Risk Scores Overview</h3>
                    <div className="space-y-2">
                        {summaries.map(s => (
                            <div key={s.farmer_id} className="flex items-center gap-3">
                                <span className="text-xs text-gray-500 w-10 font-mono">{s.farmer_id}</span>
                                <div className="flex-1 bg-gray-100 rounded-full h-6 relative">
                                    <div className="h-6 rounded-full bar-animate flex items-center justify-end pr-2"
                                         style={{ width: (s.risk_score / maxScore * 100) + '%', backgroundColor: getBarColor(s.risk_score) }}>
                                        <span className="text-xs font-bold text-white">{s.risk_score}</span>
                                    </div>
                                </div>
                                <span className="text-xs text-gray-400 w-16 truncate">{s.name.split(' ')[0]}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // ===== RISK DISTRIBUTION =====
        function RiskDistribution({ summaries }) {
            if (!summaries) return null;
            const dist = { 'Low': 0, 'Medium': 0, 'High': 0, 'Very High': 0 };
            summaries.forEach(s => { dist[s.risk_category] = (dist[s.risk_category] || 0) + 1; });
            const colors = { 'Low': 'bg-green-500', 'Medium': 'bg-amber-500', 'High': 'bg-orange-500', 'Very High': 'bg-red-500' };
            const textColors = { 'Low': 'text-green-700', 'Medium': 'text-amber-700', 'High': 'text-orange-700', 'Very High': 'text-red-700' };
            const bgColors = { 'Low': 'bg-green-50', 'Medium': 'bg-amber-50', 'High': 'bg-orange-50', 'Very High': 'bg-red-50' };
            const total = summaries.length;

            return (
                <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                    <h3 className="text-lg font-semibold text-gray-900 mb-4">Risk Distribution</h3>
                    {/* Visual bar */}
                    <div className="flex rounded-full overflow-hidden h-8 mb-6">
                        {Object.entries(dist).map(([cat, count]) => count > 0 ? (
                            <div key={cat} className={colors[cat] + ' flex items-center justify-center'}
                                 style={{ width: (count / total * 100) + '%' }}>
                                <span className="text-xs font-bold text-white">{count}</span>
                            </div>
                        ) : null)}
                    </div>
                    {/* Legend cards */}
                    <div className="grid grid-cols-2 gap-3">
                        {Object.entries(dist).map(([cat, count]) => (
                            <div key={cat} className={`${bgColors[cat]} rounded-lg p-3 text-center`}>
                                <div className={`text-2xl font-bold ${textColors[cat]}`}>{count}</div>
                                <div className={`text-xs font-medium ${textColors[cat]}`}>{cat} Risk</div>
                                <div className="text-xs text-gray-400">{Math.round(count / total * 100)}%</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // ===== ALL FARMERS TABLE =====
        function AllFarmersTable({ summaries, onSelect }) {
            if (!summaries) return null;
            const categoryColors = {
                'Low': 'bg-green-100 text-green-700',
                'Medium': 'bg-amber-100 text-amber-700',
                'High': 'bg-orange-100 text-orange-700',
                'Very High': 'bg-red-100 text-red-700',
            };
            return (
                <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                    <h3 className="text-lg font-semibold text-gray-900 mb-4">All Farmers Overview</h3>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead>
                                <tr className="border-b border-gray-200">
                                    <th className="text-left py-3 px-2 text-gray-500 font-medium">ID</th>
                                    <th className="text-left py-3 px-2 text-gray-500 font-medium">Name</th>
                                    <th className="text-left py-3 px-2 text-gray-500 font-medium">Region</th>
                                    <th className="text-left py-3 px-2 text-gray-500 font-medium">Crop</th>
                                    <th className="text-center py-3 px-2 text-gray-500 font-medium">Score</th>
                                    <th className="text-center py-3 px-2 text-gray-500 font-medium">Decision</th>
                                    <th className="text-center py-3 px-2 text-gray-500 font-medium">Risk</th>
                                    <th className="text-right py-3 px-2 text-gray-500 font-medium">BNPL Limit</th>
                                    <th className="text-center py-3 px-2 text-gray-500 font-medium">Months</th>
                                </tr>
                            </thead>
                            <tbody>
                                {summaries.map(s => (
                                    <tr key={s.farmer_id}
                                        className={'border-b border-gray-50 cursor-pointer transition-colors ' + (s.decision === 'Refused' ? 'hover:bg-red-50 bg-red-50/30' : 'hover:bg-green-50')}
                                        onClick={() => onSelect(s.farmer_id)}>
                                        <td className="py-3 px-2 text-gray-500 font-mono text-xs">{s.farmer_id}</td>
                                        <td className="py-3 px-2 font-medium text-gray-900">{s.name}</td>
                                        <td className="py-3 px-2 text-gray-600">{s.region}</td>
                                        <td className="py-3 px-2 text-gray-600 capitalize">{s.crop_type.replace(/_/g, ' ')}</td>
                                        <td className="py-3 px-2 text-center font-bold text-gray-900">{s.risk_score}</td>
                                        <td className="py-3 px-2 text-center">
                                            <span className={'px-2.5 py-1 rounded-full text-xs font-bold ' + (s.decision === 'Approved' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700')}>
                                                {s.decision}
                                            </span>
                                        </td>
                                        <td className="py-3 px-2 text-center">
                                            <span className={'px-2.5 py-1 rounded-full text-xs font-medium ' + (categoryColors[s.risk_category] || '')}>
                                                {s.risk_category}
                                            </span>
                                        </td>
                                        <td className="py-3 px-2 text-right font-medium text-gray-900">{s.decision === 'Refused' ? '-' : s.bnpl_limit.toLocaleString() + ' AZN'}</td>
                                        <td className="py-3 px-2 text-center text-gray-600">{s.decision === 'Refused' ? '-' : s.installment_months}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // ===== MAIN APP =====
        function App() {
            const [farmers, setFarmers] = useState([]);
            const [selectedFarmerId, setSelectedFarmerId] = useState('F001');
            const [dashboardData, setDashboardData] = useState(null);
            const [allSummaries, setAllSummaries] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('detail');

            useEffect(() => {
                Promise.all([
                    fetch(API_BASE + '/farmers').then(r => r.json()),
                    fetch(API_BASE + '/dashboard/all/summary').then(r => r.json()),
                ])
                .then(([farmersData, summaryData]) => {
                    setFarmers(farmersData.farmers);
                    setAllSummaries(summaryData.summaries);
                    setLoading(false);
                })
                .catch(err => {
                    console.error('API Error:', err);
                    setError('Failed to connect to API. Make sure the backend is running on http://localhost:8000');
                    setLoading(false);
                });
            }, []);

            useEffect(() => {
                if (!selectedFarmerId || farmers.length === 0) return;
                setLoading(true);
                fetch(API_BASE + '/dashboard/' + selectedFarmerId)
                    .then(r => r.json())
                    .then(data => {
                        setDashboardData(data);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error('Dashboard Error:', err);
                        setError('Failed to load dashboard data');
                        setLoading(false);
                    });
            }, [selectedFarmerId, farmers]);

            if (error && !dashboardData) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="bg-white rounded-2xl p-8 shadow-lg max-w-md text-center">
                            <div className="text-5xl mb-4">&#9888;&#65039;</div>
                            <h2 className="text-xl font-bold text-gray-900 mb-2">Connection Error</h2>
                            <p className="text-gray-500 mb-4">{error}</p>
                            <div className="bg-gray-50 rounded-lg p-4 text-left text-sm text-gray-600">
                                <p className="font-medium mb-2">To start the backend:</p>
                                <code className="block bg-gray-900 text-green-400 p-3 rounded text-xs">
                                    cd backend<br/>
                                    pip install -r requirements.txt<br/>
                                    python main.py
                                </code>
                            </div>
                        </div>
                    </div>
                );
            }

            var farmer = dashboardData ? dashboardData.farmer : null;
            var riskScore = dashboardData ? dashboardData.risk_score : null;
            var products = dashboardData ? dashboardData.products : null;
            var explanation = dashboardData ? dashboardData.explanation : null;

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="bg-white border-b border-gray-200 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex items-center justify-between h-16">
                                <div className="flex items-center gap-3">
                                    <div className="w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center">
                                        <span className="text-white font-bold text-sm">DU</span>
                                    </div>
                                    <div>
                                        <h1 className="text-lg font-bold text-gray-900">BNPL Risk Scoring Engine</h1>
                                        <p className="text-xs text-gray-400">Digital Umbrella - Aqrar Ticar&#601;t Platformas&#305;</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => setActiveTab('detail')}
                                        className={'px-4 py-2 rounded-lg text-sm font-medium transition-colors ' +
                                            (activeTab === 'detail' ? 'bg-green-600 text-white' : 'text-gray-600 hover:bg-gray-100')}>
                                        Farmer Detail
                                    </button>
                                    <button onClick={() => setActiveTab('overview')}
                                        className={'px-4 py-2 rounded-lg text-sm font-medium transition-colors ' +
                                            (activeTab === 'overview' ? 'bg-green-600 text-white' : 'text-gray-600 hover:bg-gray-100')}>
                                        All Farmers
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                        {activeTab === 'detail' ? (
                            <div className="fade-in">
                                {farmers.length > 0 && (
                                    <div className="mb-6">
                                        <FarmerSelector farmers={farmers} selectedId={selectedFarmerId} onSelect={setSelectedFarmerId} />
                                    </div>
                                )}

                                {loading ? (
                                    <div className="flex items-center justify-center py-20">
                                        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-green-600"></div>
                                    </div>
                                ) : (farmer && riskScore) ? (
                                    <div>
                                        {/* Decision Banner */}
                                        {riskScore.decision === 'Refused' && (
                                            <div className="bg-red-50 border border-red-200 rounded-xl p-4 mb-6 flex items-center gap-3">
                                                <span className="text-3xl">&#10060;</span>
                                                <div>
                                                    <h3 className="text-lg font-bold text-red-700">LOAN REQUEST REFUSED</h3>
                                                    <p className="text-sm text-red-600">Risk score {riskScore.risk_score}/100 is below the minimum threshold of 50</p>
                                                </div>
                                            </div>
                                        )}
                                        {riskScore.decision === 'Approved' && (
                                            <div className="bg-green-50 border border-green-200 rounded-xl p-4 mb-6 flex items-center gap-3">
                                                <span className="text-3xl">&#9989;</span>
                                                <div>
                                                    <h3 className="text-lg font-bold text-green-700">APPROVED</h3>
                                                    <p className="text-sm text-green-600">{riskScore.bnpl_limit.toLocaleString()} AZN for {riskScore.recommended_installment_months} months</p>
                                                </div>
                                            </div>
                                        )}

                                        {/* Farmer Info */}
                                        <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100 mb-6">
                                            <div className="flex flex-wrap items-center gap-4">
                                                <div>
                                                    <h2 className="text-xl font-bold text-gray-900">{farmer.name}</h2>
                                                    <p className="text-sm text-gray-500">{farmer.farmer_id}</p>
                                                </div>
                                                <div className="flex flex-wrap gap-2 ml-auto">
                                                    <span className="px-3 py-1 bg-gray-100 rounded-full text-xs font-medium text-gray-600">{farmer.region}</span>
                                                    <span className="px-3 py-1 bg-gray-100 rounded-full text-xs font-medium text-gray-600 capitalize">{farmer.farm_type}</span>
                                                    <span className="px-3 py-1 bg-gray-100 rounded-full text-xs font-medium text-gray-600 capitalize">{farmer.crop_type.replace(/_/g, ' ')}</span>
                                                    <span className="px-3 py-1 bg-gray-100 rounded-full text-xs font-medium text-gray-600">{farmer.farm_size_hectares} ha</span>
                                                    <span className="px-3 py-1 bg-gray-100 rounded-full text-xs font-medium text-gray-600">{farmer.years_experience} yrs exp</span>
                                                    <span className={'px-3 py-1 rounded-full text-xs font-medium ' + (farmer.land_ownership ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700')}>
                                                        {farmer.land_ownership ? 'Land Owner' : 'Not Owner'}
                                                    </span>
                                                    <span className={'px-3 py-1 rounded-full text-xs font-medium ' + (farmer.has_irrigation ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-500')}>
                                                        {farmer.has_irrigation ? 'Has Irrigation' : 'No Irrigation'}
                                                    </span>
                                                    <span className={'px-3 py-1 rounded-full text-xs font-medium ' + (farmer.has_bank_loan ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700')}>
                                                        {farmer.has_bank_loan ? 'Has Bank Loan' : 'No Bank Loan'}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Score + Stats */}
                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                                            <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100 flex items-center justify-center">
                                                <RiskScoreGauge score={riskScore.risk_score} category={riskScore.risk_category} />
                                            </div>
                                            <div className="md:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-4">
                                                <StatCard title="BNPL Limit" value={riskScore.decision === 'Refused' ? 'REFUSED' : riskScore.bnpl_limit.toLocaleString() + ' AZN'} subtitle={riskScore.decision === 'Refused' ? 'Score below 50 - not eligible' : 'Maximum approved amount'} icon="&#128176;" />
                                                <StatCard title="Installment Period" value={riskScore.decision === 'Refused' ? 'N/A' : riskScore.recommended_installment_months + ' months'} subtitle={riskScore.decision === 'Refused' ? 'Not applicable' : 'Recommended payment term'} icon="&#128197;" />
                                                <StatCard title="Confidence Level" value={riskScore.confidence_level + '%'} subtitle="Based on available data" icon="&#127919;" />
                                            </div>
                                        </div>

                                        {/* Late Payment */}
                                        <div className="mb-6">
                                            <LatePaymentBar probability={riskScore.late_payment_probability} />
                                        </div>

                                        {/* Breakdown + Products */}
                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                            <RiskFactorBreakdown explanation={explanation} />
                                            <ProductRecommendations products={products} />
                                        </div>

                                        {/* Explainability */}
                                        <div className="mb-6">
                                            <ExplainabilityPanel explanation={explanation} />
                                        </div>
                                    </div>
                                ) : null}
                            </div>
                        ) : (
                            <div className="fade-in space-y-6">
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <SimpleBarChart summaries={allSummaries} />
                                    <RiskDistribution summaries={allSummaries} />
                                </div>
                                <AllFarmersTable summaries={allSummaries}
                                    onSelect={(id) => { setSelectedFarmerId(id); setActiveTab('detail'); }} />
                            </div>
                        )}
                    </main>

                    <footer className="border-t border-gray-200 mt-12 py-6">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-xs text-gray-400">
                            Digital Umbrella BNPL Risk Scoring Engine v1.0 | Synthetic Data Only | Aqrar Ticar&#601;t Platformas&#305;
                        </div>
                    </footer>
                </div>
            );
        }

        var root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
